<!DOCTYPE html><html lang="en"><head><title>src/js/components/derived-manifests</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="src/js/components/derived-manifests"><meta name="groc-project-path" content="src/js/components/derived-manifests.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/js/components/derived-manifests.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> {
  hasPropertyChanged,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../helpers/helpers.js'</span>;
<span class="hljs-keyword">import</span> { SortyConfiguration } <span class="hljs-keyword">from</span> <span class="hljs-string">'../config/config.js'</span>;
<span class="hljs-keyword">import</span> {
  setCollectionManifest,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../actions/selected-collection.js'</span>;
<span class="hljs-keyword">import</span> {
  setDerivedManifests,
  setDerivedManifestsComplete,
  setClassifiedCanvases,
  resetDerivedManifests } <span class="hljs-keyword">from</span> <span class="hljs-string">'../actions/loaded-manifest.js'</span>;
<span class="hljs-keyword">import</span> { updateThumbsWithStatus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./thumbs.js'</span>;
<span class="hljs-keyword">import</span> { IIIFActions } <span class="hljs-keyword">from</span> <span class="hljs-string">'./iiif-actions.js'</span>;
<span class="hljs-keyword">import</span> { getTerm } <span class="hljs-keyword">from</span> <span class="hljs-string">'../config/terms.js'</span>;
<span class="hljs-keyword">import</span> { OmekaActions, omekaServiceProfile } <span class="hljs-keyword">from</span> <span class="hljs-string">'./omeka-actions.js'</span>;

<span class="hljs-keyword">const</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);

<span class="hljs-keyword">const</span> manifestSelector = <span class="hljs-string">'.manifest-select__dropdown'</span>;
<span class="hljs-keyword">const</span> viewManifest = <span class="hljs-string">'.manifest-select__view-uv'</span>;

<span class="hljs-keyword">let</span> store = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> manifestStore = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> lastLocalState = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> lastTitleText = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">const</span> Config = {
  deleteManifestModalOptions: {
    delegate: <span class="hljs-string">'.action__delete'</span>,
    items: {
      src: <span class="hljs-string">'#deleteManifestmodal'</span>,
      type: <span class="hljs-string">'inline'</span>,
    },
    modal: <span class="hljs-literal">true</span>,
  },
};

<span class="hljs-keyword">const</span> DOM = {
  init() {
    DOM.$classifiedMaterial = $(<span class="hljs-string">'.classified-material'</span>);
    DOM.$classifiedTitle = $(<span class="hljs-string">'.viewer__classified-title'</span>);
    DOM.$deleteModalHeading = $(<span class="hljs-string">'.manifest-modal--delete .manifest-modal__heading'</span>);
    DOM.$deleteModalStatus = $(<span class="hljs-string">'.manifest-modal--delete .manifest-modal__deleting-text'</span>);
    DOM.$manifestSelector = $(manifestSelector);
  },
};

<span class="hljs-keyword">const</span> buildClassified = (derivedManifestList) =&gt; {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;buildClassified&#39;, DOM.$classifiedMaterial != null &amp;&amp;</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (DOM.$classifiedMaterial != <span class="hljs-literal">null</span> &amp;&amp; DOM.$classifiedMaterial.length) {
    <span class="hljs-keyword">const</span> preferredHeight = <span class="hljs-built_in">parseInt</span>(localStorage.getItem(<span class="hljs-string">'thumbSize'</span>), <span class="hljs-number">10</span>);
    <span class="hljs-keyword">const</span> preferredWidth = preferredHeight / <span class="hljs-number">1.5</span>;
    <span class="hljs-keyword">const</span> placeholder = <span class="hljs-string">'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB'</span>
    + <span class="hljs-string">'CAQAAAC1HAwCAAAAC0lEQVR42mO8+R8AArcB2pIvCSwAAAAASUVORK5CYII='</span>;

    DOM.$classifiedMaterial.html(<span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span> (derivedManifestList &amp;&amp; derivedManifestList.members) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; derivedManifestList.members.length; i++) {
        <span class="hljs-keyword">const</span> manifest = derivedManifestList.members[i];
        <span class="hljs-keyword">const</span> label = manifest.label || manifest[<span class="hljs-string">'@id'</span>];

        <span class="hljs-keyword">const</span> publishToOmekaButton = SortyConfiguration.enableOmekaImport ?
        <span class="hljs-string">`&lt;li class="classified-manifest__actions-item"&gt;
          &lt;a href="#" class="action__publish"&gt;
          &lt;i class="material-icons"&gt;publish&lt;/i&gt;Publish to Omeka
          &lt;/a&gt;
        &lt;/li&gt;`</span> : <span class="hljs-string">''</span>;

        <span class="hljs-keyword">const</span> deleteButton = SortyConfiguration.enableDelete ?
        <span class="hljs-string">`&lt;li class="classified-manifest__actions-item"&gt;
          &lt;a href="#" class="action__delete"&gt;
          &lt;i class="material-icons"&gt;delete_forever&lt;/i&gt;Delete this
          <span class="hljs-subst">${getTerm('derivedManifest', 1)}</span>
          &lt;/a&gt;
        &lt;/li&gt;`</span> : <span class="hljs-string">''</span>;

        DOM.$classifiedMaterial.append(<span class="hljs-string">`
          &lt;div class="classified-manifest" data-id="<span class="hljs-subst">${manifest['@id']}</span>"&gt;
            &lt;div class="classified-manifest__front classified-manifest__front--placeholder"&gt;
              &lt;img src="<span class="hljs-subst">${placeholder}</span>" \
              height="<span class="hljs-subst">${preferredHeight}</span>" width="<span class="hljs-subst">${preferredWidth}</span>" /&gt;
            &lt;/div&gt;
            &lt;div class="classified-manifest__second classified-manifest__second--placeholder"&gt;
              &lt;img src="<span class="hljs-subst">${placeholder}</span>" \
              height="<span class="hljs-subst">${preferredHeight}</span>" width="<span class="hljs-subst">${preferredWidth}</span>" /&gt;
            &lt;/div&gt;
            &lt;div class="classified-manifest__third classified-manifest__third--placeholder"&gt;
              &lt;img src="<span class="hljs-subst">${placeholder}</span>" \
              height="<span class="hljs-subst">${preferredHeight}</span>" width="<span class="hljs-subst">${preferredWidth}</span>" /&gt;
            &lt;/div&gt;
            &lt;h2 class="classified-manifest__title"&gt;
              &lt;span class="classified-manifest__title-text"&gt;<span class="hljs-subst">${label}</span>&lt;/span&gt;
              &lt;button class="classified-manifest__title-edit" title="Edit label"&gt;
                &lt;i class="material-icons"&gt;mode_edit&lt;/i&gt;
              &lt;/button&gt;
              &lt;button class="classified-manifest__title-save" title="Save label"&gt;
                &lt;i class="material-icons"&gt;save&lt;/i&gt;
              &lt;/button&gt;
            &lt;/h2&gt;
            &lt;p class="classified-manifest__num"&gt;{x} images&lt;/p&gt;
            &lt;div class="classified-manifest__actions"&gt;
              &lt;ul class="classified-manifest__actions-list"&gt;
                <span class="hljs-subst">${publishToOmekaButton}</span>
                <span class="hljs-subst">${deleteButton}</span>
                &lt;li class="classified-manifest__actions-item"&gt;
                  &lt;a href="http://universalviewer.io/?manifest=<span class="hljs-subst">${manifest['@id']}</span>"
                  class="action__view" target="_blank"&gt;
                  &lt;i class="material-icons"&gt;open_in_new&lt;/i&gt;View in the Universal Viewer
                  &lt;/a&gt;
                &lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;`</span>);
      }
    }
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> loadManifestPage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadManifestPage</span>(<span class="hljs-params">manifestUrl</span>) </span>{
  <span class="hljs-built_in">window</span>.open(<span class="hljs-string">`http://universalviewer.io/?manifest=<span class="hljs-subst">${manifestUrl}</span>`</span>, <span class="hljs-string">'_blank'</span>);
};

<span class="hljs-keyword">const</span> updateArchivalUnits = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> state = manifestStore.getState();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make sure the list exists first</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (state.derivedManifestsComplete.length) {
    <span class="hljs-keyword">if</span> (DOM.$classifiedMaterial.find(<span class="hljs-string">'.classified-manifest'</span>).length &lt;
    state.derivedManifests.members.length) {
      buildClassified(state.derivedManifests);
    }

    DOM.$classifiedTitle.text(<span class="hljs-string">`<span class="hljs-subst">${state.derivedManifestsComplete.length}</span>
      <span class="hljs-subst">${getTerm('derivedManifest', state.derivedManifestsComplete.length)}</span>`</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dm <span class="hljs-keyword">of</span> state.derivedManifestsComplete) {
      <span class="hljs-keyword">const</span> id = dm[<span class="hljs-string">'@id'</span>];
      <span class="hljs-keyword">const</span> canvases = dm.sequences[<span class="hljs-number">0</span>].canvases;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add marker to indicate a dm has been loaded</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> $cmContainer = $(<span class="hljs-string">`.classified-manifest[data-id='<span class="hljs-subst">${id}</span>']`</span>)
      .addClass(<span class="hljs-string">'classified-manifest--loaded'</span>);
      $cmContainer.find(<span class="hljs-string">'.classified-manifest__num'</span>)
      .text(<span class="hljs-string">`<span class="hljs-subst">${canvases.length}</span> images`</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get publish to omeka status</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dm.service !== <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">const</span> services = <span class="hljs-built_in">Array</span>.isArray(dm.service) ? dm.service : [dm.service];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> service <span class="hljs-keyword">of</span> services) {
          <span class="hljs-keyword">if</span> (service.profile === omekaServiceProfile) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Has been published</p></div></div><div class="code"><div class="wrapper">            $cmContainer.find(<span class="hljs-string">'.action__publish'</span>)
            .replaceWith(<span class="hljs-string">'&lt;p class="classified-manifest__status"&gt;Published to Omeka&lt;/p&gt;'</span>);
            <span class="hljs-keyword">break</span>;
          }
        }
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: DRY this out..</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> $cmImgFront = $cmContainer.find(<span class="hljs-string">'.classified-manifest__front img'</span>);
      <span class="hljs-keyword">const</span> $cmImgSecond = $cmContainer.find(<span class="hljs-string">'.classified-manifest__second img'</span>);
      <span class="hljs-keyword">const</span> $cmImgThird = $cmContainer.find(<span class="hljs-string">'.classified-manifest__third img'</span>);
      <span class="hljs-keyword">if</span> (canvases.length &gt; <span class="hljs-number">0</span> &amp;&amp; canvases[<span class="hljs-number">0</span>].images.length) {
        <span class="hljs-keyword">const</span> imgSrcFront = $(<span class="hljs-string">`.thumb[data-uri='<span class="hljs-subst">${canvases[0].images[0].on}</span>']`</span>).attr(<span class="hljs-string">'data-src'</span>);
        $cmImgFront.attr(<span class="hljs-string">'src'</span>, imgSrcFront)
        .removeClass(<span class="hljs-string">'classified-manifest__front--placeholder'</span>);
      }
      <span class="hljs-keyword">if</span> (canvases.length &gt; <span class="hljs-number">1</span> &amp;&amp; canvases[<span class="hljs-number">1</span>].images.length) {
        <span class="hljs-keyword">const</span> imgSrcSecond = $(<span class="hljs-string">`.thumb[data-uri='<span class="hljs-subst">${canvases[1].images[0].on}</span>']`</span>).attr(<span class="hljs-string">'data-src'</span>);
        $cmImgSecond.attr(<span class="hljs-string">'src'</span>, imgSrcSecond)
        .removeClass(<span class="hljs-string">'classified-manifest__second--placeholder'</span>);
      } <span class="hljs-keyword">else</span> {
        $cmImgSecond.hide();
      }
      <span class="hljs-keyword">if</span> (canvases.length &gt; <span class="hljs-number">2</span> &amp;&amp; canvases[<span class="hljs-number">2</span>].images.length) {
        <span class="hljs-keyword">const</span> imgSrcThird = $(<span class="hljs-string">`.thumb[data-uri='<span class="hljs-subst">${canvases[2].images[0].on}</span>']`</span>).attr(<span class="hljs-string">'data-src'</span>);
        $cmImgThird.attr(<span class="hljs-string">'src'</span>, imgSrcThird)
        .removeClass(<span class="hljs-string">'classified-manifest__third--placeholder'</span>);
      } <span class="hljs-keyword">else</span> {
        $cmImgThird.hide();
      }
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clean up - possible that derived manifests were listed but don&#39;t actually exist
Edge case</p></div></div><div class="code"><div class="wrapper">    $(<span class="hljs-string">'.classified-manifest:not(.classified-manifest--loaded)'</span>).remove();
  }
};

<span class="hljs-keyword">const</span> cancelEdits = (resetText = <span class="hljs-literal">false</span>) =&gt; {
  <span class="hljs-keyword">const</span> $contentEditableTitleText = $(<span class="hljs-string">'.classified-manifest__title-text[contenteditable]'</span>);
  <span class="hljs-keyword">const</span> $contentEditableTitle = $(<span class="hljs-string">'.classified-manifest__title--edit'</span>);
  $contentEditableTitleText.removeAttr(<span class="hljs-string">'contenteditable'</span>);
  $contentEditableTitle.removeClass(<span class="hljs-string">'classified-manifest__title--edit'</span>);
  <span class="hljs-keyword">if</span> (resetText) $contentEditableTitleText.html(lastTitleText);
};

<span class="hljs-keyword">const</span> Events = {
  bodyClick(e) {
    <span class="hljs-keyword">if</span> (
      e.target.className !== <span class="hljs-string">'classified-manifest__title-edit'</span> &amp;&amp;
      e.target.className !== <span class="hljs-string">'classified-manifest__title-save'</span> &amp;&amp;
      e.target.className !== <span class="hljs-string">'material-icons'</span>
    ) {
      cancelEdits(<span class="hljs-literal">true</span>);
      $(<span class="hljs-string">'body'</span>).off(<span class="hljs-string">'click'</span>, Events.bodyClick);
    }
  },
  <span class="hljs-keyword">delete</span>(e) {
    e.preventDefault();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use a modal here - Are you sure you want to delete?</p></div></div><div class="code"><div class="wrapper">    $.magnificPopup.open(Config.deleteManifestModalOptions);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Grab manifest URL</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> $container = $(<span class="hljs-keyword">this</span>).closest(<span class="hljs-string">'.classified-manifest'</span>);
    <span class="hljs-keyword">const</span> manifestId = $container.attr(<span class="hljs-string">'data-id'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hook up delete button behaviour (remove any existing click events)</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> $deleteButton = $(<span class="hljs-string">'.manifest-modal__delete'</span>).off(<span class="hljs-string">'click'</span>);
    $deleteButton.click(() =&gt; {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Show delete indicator</p></div></div><div class="code"><div class="wrapper">      $(<span class="hljs-string">'html'</span>).addClass(<span class="hljs-string">'deleting-manifest'</span>);

      $container.addClass(<span class="hljs-string">'classified-manifest--deleting'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Delete the manifest</p></div></div><div class="code"><div class="wrapper">      IIIFActions.deleteManifest(manifestId, Events.deleteSuccess, Events.deleteError);
    });
  },
  deleteError(xhr, textStatus, error) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ERROR DELETING'</span>, error);
    $(<span class="hljs-string">'.classified-manifest--deleting'</span>).removeClass(<span class="hljs-string">'classified-manifest--deleting'</span>);
  },
  deleteSuccess() {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hide delete indicator</p></div></div><div class="code"><div class="wrapper">    $(<span class="hljs-string">'html'</span>).removeClass(<span class="hljs-string">'deleting-manifest'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Kill the item stack</p></div></div><div class="code"><div class="wrapper">    $(<span class="hljs-string">'.classified-manifest--deleting'</span>).remove();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Close the modal</p></div></div><div class="code"><div class="wrapper">    $.magnificPopup.close();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fetch updated derived manifest data</p></div></div><div class="code"><div class="wrapper">    Events.getCreatedManifests();
  },
  domReady() {
    DOM.init();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set terms</p></div></div><div class="code"><div class="wrapper">    DOM.$deleteModalHeading.html(<span class="hljs-string">`Are you sure you want to delete
      this <span class="hljs-subst">${getTerm('derivedManifest', 0)}</span>?`</span>);
    DOM.$deleteModalStatus.html(<span class="hljs-string">`Deleting <span class="hljs-subst">${getTerm('derivedManifest', 0)}</span>`</span>);

    Events.init();
  },
  editTitleClick() {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cancel any other edit operations first</p></div></div><div class="code"><div class="wrapper">    cancelEdits(<span class="hljs-literal">true</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make the title editable</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> $parentTitle = $(<span class="hljs-keyword">this</span>).closest(<span class="hljs-string">'.classified-manifest__title'</span>);
    $parentTitle.addClass(<span class="hljs-string">'classified-manifest__title--edit'</span>);

    <span class="hljs-keyword">const</span> $editableText = $parentTitle.find(<span class="hljs-string">'.classified-manifest__title-text'</span>);

    lastTitleText = $editableText.text();
    $editableText.attr(<span class="hljs-string">'contenteditable'</span>, <span class="hljs-string">'true'</span>);
    $editableText.focus();
    $(<span class="hljs-string">'body'</span>).click(Events.bodyClick);
  },
  editTitleKeypress(e) {
    <span class="hljs-keyword">if</span> (e.key === <span class="hljs-string">'Enter'</span>) {
      e.preventDefault();
      $(<span class="hljs-keyword">this</span>).closest(<span class="hljs-string">'.classified-manifest'</span>).find(<span class="hljs-string">'.classified-manifest__title-save'</span>)
      .click();
    }
  },
  getCreatedManifests() {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get the container in presley</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> collectionId = SortyConfiguration
    .getCollectionUrl(manifestStore.getState().manifest);

    $.getJSON(collectionId)
        .done(Events.requestDerivedManifestsSuccess)
        .fail(Events.requestDerivedManifestsFailure);
  },
  init() {
    DOM.$classifiedMaterial.on(<span class="hljs-string">'click'</span>,
    <span class="hljs-string">'.classified-manifest__title-edit, .classified-manifest__title-text'</span>,
    Events.editTitleClick);
    DOM.$classifiedMaterial.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.classified-manifest__title-save'</span>, Events.saveTitleClick);
    DOM.$classifiedMaterial.on(<span class="hljs-string">'keypress'</span>,
    <span class="hljs-string">'.classified-manifest__title--edit .classified-manifest__title-text'</span>,
    Events.editTitleKeypress
    );
    DOM.$classifiedMaterial.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.classified-manifest'</span>, (e) =&gt; e.stopPropagation());
    DOM.$classifiedMaterial.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.action__publish'</span>, Events.publish);
    DOM.$classifiedMaterial.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.action__delete'</span>, Events.delete);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>DOM.$classifiedMaterial.magnificPopup(Config.deleteManifestModalOptions);</p></div></div><div class="code"><div class="wrapper">  },
  postError(xhr, textStatus, error) {
    <span class="hljs-built_in">console</span>.log(error);
  },
  postSuccess() {
    cancelEdits();
    $(<span class="hljs-string">'.classified-manifest--saving-label'</span>).removeClass(<span class="hljs-string">'classified-manifest--saving-label'</span>);
  },
  postOmekaServiceError(xhr, textStatus, error) {
    <span class="hljs-built_in">console</span>.log(error);
  },
  publish(e) {
    e.preventDefault();
    <span class="hljs-keyword">const</span> $container = $(<span class="hljs-keyword">this</span>).closest(<span class="hljs-string">'.classified-manifest'</span>);
    <span class="hljs-keyword">const</span> manifestId = $container.attr(<span class="hljs-string">'data-id'</span>);
    OmekaActions.pushToOmeka(manifestId)
    .then(() =&gt; {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>fulfilled</p></div></div><div class="code"><div class="wrapper">      OmekaActions.addOmekaService(manifestId).then(() =&gt; {
        Events.getCreatedManifests();
      });
    },
    () =&gt; {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>rejected</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'failed to push to omeka'</span>);
    });</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(manifestId);</p></div></div><div class="code"><div class="wrapper">  },
  putError(xhr, textStatus, error) {
    alert(error);
  },
  putSuccess() {
    <span class="hljs-keyword">const</span> manifest = store.getState().selectedCollection.collectionManifest;
    <span class="hljs-keyword">const</span> newManifestInstance = <span class="hljs-built_in">Object</span>.assign({}, manifest);
    newManifestInstance.sequences = <span class="hljs-literal">null</span>;
    newManifestInstance.service = <span class="hljs-literal">null</span>;
    IIIFActions.postManifest(
      manifest,
      SortyConfiguration.getCollectionUrl(manifestStore.getState().manifest),
      Events.postSuccess,
      Events.postError
    );
  },
  requestDerivedManifestsFailure() {
    manifestStore.dispatch(resetDerivedManifests());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there&#39;s no derived manifest - just show the list</p></div></div><div class="code"><div class="wrapper">    $(<span class="hljs-string">'html'</span>).addClass(<span class="hljs-string">'manifest-loaded'</span>);
  },
  requestDerivedManifestsSuccess(collection) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>IIIF.wrap(collection);
console.log(&#39;Request derived manifests success&#39;, collection);</p></div></div><div class="code"><div class="wrapper">    manifestStore.dispatch(setDerivedManifests(collection));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;RDMS&#39;, collection);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> promises = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dm <span class="hljs-keyword">of</span> collection.members) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;dm&#39;, dm);</p></div></div><div class="code"><div class="wrapper">      promises.push(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
        $.getJSON(dm[<span class="hljs-string">'@id'</span>])
        .done(resolve)
        .fail((jqxhr, textStatus, error) =&gt; {
          <span class="hljs-built_in">console</span>.log(jqxhr, textStatus, error);
          <span class="hljs-keyword">if</span> (jqxhr.status === <span class="hljs-number">404</span>) {
            resolve();
          } <span class="hljs-keyword">else</span> {
            reject();
          }
        });
      }));
    }
    <span class="hljs-keyword">const</span> classifiedCanvases = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>();
    <span class="hljs-keyword">const</span> classifiedManifests = [];
    <span class="hljs-built_in">Promise</span>.all(promises).then(values =&gt; {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> manifest <span class="hljs-keyword">of</span> values) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> manifest !== <span class="hljs-string">'undefined'</span> &amp;&amp; manifest !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> canvas <span class="hljs-keyword">of</span> manifest.sequences[<span class="hljs-number">0</span>].canvases) {
            <span class="hljs-keyword">if</span> (canvas.images.length) {
              classifiedCanvases.add(canvas.images[<span class="hljs-number">0</span>].on);
            }
          }
          classifiedManifests.push(manifest);
        }
      }
      manifestStore.dispatch(setClassifiedCanvases(classifiedCanvases));
      manifestStore.dispatch(setDerivedManifestsComplete(classifiedManifests));

      $(<span class="hljs-string">'html'</span>).addClass(<span class="hljs-string">'dm-loaded manifest-loaded'</span>);
      updateThumbsWithStatus();
    }, reason =&gt; {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Promise fail'</span>, reason);
    });
    $(viewManifest).click(Events.viewManifestClick);
  },
  saveTitleClick() {
    <span class="hljs-keyword">const</span> $parentTitle = $(<span class="hljs-keyword">this</span>).closest(<span class="hljs-string">'.classified-manifest__title'</span>);
    <span class="hljs-keyword">const</span> $container = $(<span class="hljs-keyword">this</span>).closest(<span class="hljs-string">'.classified-manifest'</span>);
    <span class="hljs-keyword">const</span> $editableText = $parentTitle.find(<span class="hljs-string">'.classified-manifest__title-text'</span>);
    <span class="hljs-keyword">const</span> manifestId = $container.attr(<span class="hljs-string">'data-id'</span>);
    <span class="hljs-keyword">const</span> titleText = $editableText.text();
    <span class="hljs-keyword">const</span> derivedManifests = manifestStore.getState().derivedManifestsComplete;
    <span class="hljs-keyword">let</span> manifestToUpdate = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dm <span class="hljs-keyword">of</span> derivedManifests) {
      <span class="hljs-keyword">if</span> (dm[<span class="hljs-string">'@id'</span>] === manifestId) {
        manifestToUpdate = dm;
        <span class="hljs-keyword">break</span>;
      }
    }
    <span class="hljs-keyword">if</span> (manifestToUpdate !== <span class="hljs-literal">null</span>) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update label</p></div></div><div class="code"><div class="wrapper">      manifestToUpdate.label = titleText;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set saving state</p></div></div><div class="code"><div class="wrapper">      $container.addClass(<span class="hljs-string">'classified-manifest--saving-label'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Store new manifest</p></div></div><div class="code"><div class="wrapper">      store.dispatch(setCollectionManifest(manifestToUpdate));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>RE-PUT</p></div></div><div class="code"><div class="wrapper">      IIIFActions.putManifest(manifestToUpdate, Events.putSuccess, Events.putError);
    } <span class="hljs-keyword">else</span> {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Cancel edit</p></div></div><div class="code"><div class="wrapper">      cancelEdits(<span class="hljs-literal">true</span>);
    }
    $(<span class="hljs-string">'body'</span>).off(<span class="hljs-string">'click'</span>, Events.bodyClick);
  },
  subscribeActions() {
    <span class="hljs-keyword">const</span> derivedState = manifestStore.getState();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;DM - subscribe&#39;, lastLocalState, derivedState);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (hasPropertyChanged(<span class="hljs-string">'derivedManifests'</span>, derivedState, lastLocalState)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;DM - changed&#39;, derivedState);</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (derivedState.derivedManifests.length) {
        <span class="hljs-keyword">const</span> derivedManifestList = derivedState.derivedManifests;
        buildClassified(derivedManifestList);
      }
    }
    <span class="hljs-keyword">if</span> (hasPropertyChanged(<span class="hljs-string">'classifiedCanvases'</span>, derivedState, lastLocalState)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;classifiedCanvases changed&#39;, derivedState, lastLocalState);</p></div></div><div class="code"><div class="wrapper">    }
    <span class="hljs-keyword">if</span> (hasPropertyChanged(<span class="hljs-string">'derivedManifestsComplete'</span>, derivedState, lastLocalState)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;derivedManifestsComplete - updateArchivalUnits&#39;);</p></div></div><div class="code"><div class="wrapper">      updateArchivalUnits();
    }
    lastLocalState = derivedState;
  },
  viewManifestClick() {
    loadManifestPage(DOM.$manifestSelector.val());
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getCreatedManifests = Events.getCreatedManifests;

$(<span class="hljs-built_in">document</span>).ready(Events.domReady);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> derivedManifestsInit = (globalStore, globalManifestStore) =&gt; {
  store = globalStore;
  manifestStore = globalManifestStore;
  manifestStore.subscribe(Events.subscribeActions);
};</div></div></div></div></body></html>
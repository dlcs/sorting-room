<!DOCTYPE html><html lang="en"><head><title>src/js/components/derived-manifests</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="src/js/components/derived-manifests"><meta name="groc-project-path" content="src/js/components/derived-manifests.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/js/components/derived-manifests.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> {
  hasPropertyChanged,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../helpers/helpers.js'</span>;
<span class="hljs-keyword">import</span> { SortyConfiguration } <span class="hljs-keyword">from</span> <span class="hljs-string">'../config/config.js'</span>;
<span class="hljs-keyword">import</span> {
  setCollectionManifest,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../actions/selected-collection.js'</span>;
<span class="hljs-keyword">import</span> {
  setDerivedManifests,
  setDerivedManifestsComplete,
  setClassifiedCanvases,
  resetDerivedManifests } <span class="hljs-keyword">from</span> <span class="hljs-string">'../actions/loaded-manifest.js'</span>;
<span class="hljs-keyword">import</span> { updateThumbsWithStatus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./thumbs.js'</span>;
<span class="hljs-keyword">import</span> { IIIFActions } <span class="hljs-keyword">from</span> <span class="hljs-string">'./iiif-actions.js'</span>;
<span class="hljs-keyword">import</span> { getTerm } <span class="hljs-keyword">from</span> <span class="hljs-string">'../config/terms.js'</span>;
<span class="hljs-keyword">import</span> { OmekaActions, omekaServiceProfile } <span class="hljs-keyword">from</span> <span class="hljs-string">'./omeka-actions.js'</span>;
<span class="hljs-keyword">import</span> {getOmekaToken} <span class="hljs-keyword">from</span> <span class="hljs-string">"../helpers/oauth"</span>;

<span class="hljs-keyword">const</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);

<span class="hljs-keyword">const</span> manifestSelector = <span class="hljs-string">'.manifest-select__dropdown'</span>;
<span class="hljs-keyword">const</span> viewManifest = <span class="hljs-string">'.manifest-select__view-uv'</span>;

<span class="hljs-keyword">let</span> store = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> manifestStore = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> lastLocalState = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> lastTitleText = <span class="hljs-literal">null</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>const Config = {
  deleteManifestModalOptions: {
    delegate: &#39;.action__delete&#39;,
    items: {
      src: &#39;#deleteManifestmodal&#39;,
      type: &#39;inline&#39;,
    },
    modal: true,
  },</p></div></div><div class="code"><div class="wrapper"><span class="hljs-comment">// ;</span>

<span class="hljs-keyword">const</span> DOM = {
  init() {
    DOM.$classifiedMaterial = $(<span class="hljs-string">'.classified-material'</span>);
    DOM.$classifiedTitle = $(<span class="hljs-string">'.viewer__classified-title'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>DOM.$deleteModalHeading = $(&#39;.manifest-modal--delete .manifest-modal<strong>heading&#39;);
DOM.$deleteModalStatus = $(&#39;.manifest-modal--delete .manifest-modal</strong>deleting-text&#39;);</p></div></div><div class="code"><div class="wrapper">    DOM.$manifestSelector = $(manifestSelector);
  },
};

<span class="hljs-keyword">const</span> buildClassified = (derivedManifestList) =&gt; {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;buildClassified&#39;, DOM.$classifiedMaterial != null &amp;&amp;</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (DOM.$classifiedMaterial != <span class="hljs-literal">null</span> &amp;&amp; DOM.$classifiedMaterial.length) {
    <span class="hljs-keyword">const</span> preferredHeight = <span class="hljs-built_in">parseInt</span>(localStorage.getItem(<span class="hljs-string">'thumbSize'</span>), <span class="hljs-number">10</span>);
    <span class="hljs-keyword">const</span> preferredWidth = preferredHeight / <span class="hljs-number">1.5</span>;
    <span class="hljs-keyword">const</span> placeholder = <span class="hljs-string">'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB'</span>
    + <span class="hljs-string">'CAQAAAC1HAwCAAAAC0lEQVR42mO8+R8AArcB2pIvCSwAAAAASUVORK5CYII='</span>;

    DOM.$classifiedMaterial.html(<span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span> (derivedManifestList &amp;&amp; derivedManifestList.members) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; derivedManifestList.members.length; i++) {
        <span class="hljs-keyword">const</span> manifest = derivedManifestList.members[i];
        <span class="hljs-keyword">const</span> label = manifest.label || manifest[<span class="hljs-string">'@id'</span>];</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>const publishToOmekaButton = SortyConfiguration.enableOmekaImport ?
<code>&lt;li class=&quot;classified-manifest__actions-item&quot;&gt;
  &lt;a href=&quot;#&quot; class=&quot;action__publish&quot;&gt;
  &lt;i class=&quot;material-icons&quot;&gt;publish&lt;/i&gt;Publish to Omeka
  &lt;/a&gt;
&lt;/li&gt;</code> : &#39;&#39;;</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>const deleteButton = SortyConfiguration.enableDelete ?
<code>&lt;li class=&quot;classified-manifest__actions-item&quot;&gt;
  &lt;a href=&quot;#&quot; class=&quot;action__delete&quot;&gt;
  &lt;i class=&quot;material-icons&quot;&gt;delete_forever&lt;/i&gt;Delete this
  ${getTerm(&#39;derivedManifest&#39;, 1)}
  &lt;/a&gt;
&lt;/li&gt;</code> : &#39;&#39;;</p></div></div><div class="code"><div class="wrapper">        DOM.$classifiedMaterial.append(<span class="hljs-string">`
          &lt;div class="classified-manifest" data-id="<span class="hljs-subst">${manifest['@id']}</span>"&gt;
            &lt;div class="classified-manifest__front classified-manifest__front--placeholder"&gt;
              &lt;img src="<span class="hljs-subst">${placeholder}</span>" \
              height="<span class="hljs-subst">${preferredHeight}</span>" width="<span class="hljs-subst">${preferredWidth}</span>" /&gt;
            &lt;/div&gt;
            &lt;div class="classified-manifest__second classified-manifest__second--placeholder"&gt;
              &lt;img src="<span class="hljs-subst">${placeholder}</span>" \
              height="<span class="hljs-subst">${preferredHeight}</span>" width="<span class="hljs-subst">${preferredWidth}</span>" /&gt;
            &lt;/div&gt;
            &lt;div class="classified-manifest__third classified-manifest__third--placeholder"&gt;
              &lt;img src="<span class="hljs-subst">${placeholder}</span>" \
              height="<span class="hljs-subst">${preferredHeight}</span>" width="<span class="hljs-subst">${preferredWidth}</span>" /&gt;
            &lt;/div&gt;
            &lt;h2 class="classified-manifest__title"&gt;
              &lt;span class="classified-manifest__title-text"&gt;<span class="hljs-subst">${label}</span>&lt;/span&gt;
            &lt;/h2&gt;
            &lt;p class="classified-manifest__num"&gt;{x} images&lt;/p&gt;
            &lt;div class="classified-manifest__actions"&gt;
              &lt;ul class="classified-manifest__actions-list"&gt;
                &lt;li class="classified-manifest__actions-item"&gt;
                  &lt;a href="http://universalviewer.io/?manifest=<span class="hljs-subst">${manifest['@id']}</span>"
                  class="action__view" target="_blank"&gt;
                  &lt;i class="material-icons"&gt;open_in_new&lt;/i&gt;View in the Universal Viewer
                  &lt;/a&gt;
                &lt;/li&gt;
                &lt;li class="classified-manifest__actions-item"&gt;
                  &lt;a href="<span class="hljs-subst">${SortyConfiguration.madocServer}</span>admin/item/<span class="hljs-subst">${manifest['o:id']}</span>"
                  class="action__view" target="_blank"&gt;
                  &lt;i class="material-icons"&gt;open_in_new&lt;/i&gt;Edit in Madoc
                  &lt;/a&gt;
                &lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;`</span>);
      }
    }
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> loadManifestPage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadManifestPage</span>(<span class="hljs-params">manifestUrl</span>) </span>{
  <span class="hljs-built_in">window</span>.open(<span class="hljs-string">`http://universalviewer.io/?manifest=<span class="hljs-subst">${manifestUrl}</span>`</span>, <span class="hljs-string">'_blank'</span>);
};

<span class="hljs-keyword">const</span> updateArchivalUnits = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> state = manifestStore.getState();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make sure the list exists first</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (state.derivedManifestsComplete.length) {
    <span class="hljs-keyword">if</span> (DOM.$classifiedMaterial.find(<span class="hljs-string">'.classified-manifest'</span>).length &lt;
    state.derivedManifests.members.length) {
      buildClassified(state.derivedManifests);
    }

    DOM.$classifiedTitle.text(<span class="hljs-string">`<span class="hljs-subst">${state.derivedManifestsComplete.length}</span>
      <span class="hljs-subst">${getTerm('derivedManifest', state.derivedManifestsComplete.length)}</span>`</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dm <span class="hljs-keyword">of</span> state.derivedManifestsComplete) {
      <span class="hljs-keyword">const</span> id = dm[<span class="hljs-string">'@id'</span>];
      <span class="hljs-keyword">const</span> canvases = dm.sequences[<span class="hljs-number">0</span>].canvases;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Add marker to indicate a dm has been loaded</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> $cmContainer = $(<span class="hljs-string">`.classified-manifest[data-id='<span class="hljs-subst">${id}</span>']`</span>)
      .addClass(<span class="hljs-string">'classified-manifest--loaded'</span>);
      $cmContainer.find(<span class="hljs-string">'.classified-manifest__num'</span>)
      .text(<span class="hljs-string">`<span class="hljs-subst">${canvases.length}</span> images`</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get publish to omeka status</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dm.service !== <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">const</span> services = <span class="hljs-built_in">Array</span>.isArray(dm.service) ? dm.service : [dm.service];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> service <span class="hljs-keyword">of</span> services) {
          <span class="hljs-keyword">if</span> (service.profile === omekaServiceProfile) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Has been published</p></div></div><div class="code"><div class="wrapper">            $cmContainer.find(<span class="hljs-string">'.action__publish'</span>)
            .replaceWith(<span class="hljs-string">'&lt;p class="classified-manifest__status"&gt;Published to Omeka&lt;/p&gt;'</span>);
            <span class="hljs-keyword">break</span>;
          }
        }
      }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: DRY this out..</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">const</span> $cmImgFront = $cmContainer.find(<span class="hljs-string">'.classified-manifest__front img'</span>);
      <span class="hljs-keyword">const</span> $cmImgSecond = $cmContainer.find(<span class="hljs-string">'.classified-manifest__second img'</span>);
      <span class="hljs-keyword">const</span> $cmImgThird = $cmContainer.find(<span class="hljs-string">'.classified-manifest__third img'</span>);
      <span class="hljs-keyword">if</span> (canvases.length &gt; <span class="hljs-number">0</span> &amp;&amp; canvases[<span class="hljs-number">0</span>].images.length) {
        <span class="hljs-keyword">const</span> imgSrcFront = $(<span class="hljs-string">`.thumb[data-uri='<span class="hljs-subst">${canvases[0].images[0].on}</span>']`</span>).attr(<span class="hljs-string">'data-src'</span>);
        $cmImgFront.attr(<span class="hljs-string">'src'</span>, imgSrcFront)
        .removeClass(<span class="hljs-string">'classified-manifest__front--placeholder'</span>);
      }
      <span class="hljs-keyword">if</span> (canvases.length &gt; <span class="hljs-number">1</span> &amp;&amp; canvases[<span class="hljs-number">1</span>].images.length) {
        <span class="hljs-keyword">const</span> imgSrcSecond = $(<span class="hljs-string">`.thumb[data-uri='<span class="hljs-subst">${canvases[1].images[0].on}</span>']`</span>).attr(<span class="hljs-string">'data-src'</span>);
        $cmImgSecond.attr(<span class="hljs-string">'src'</span>, imgSrcSecond)
        .removeClass(<span class="hljs-string">'classified-manifest__second--placeholder'</span>);
      } <span class="hljs-keyword">else</span> {
        $cmImgSecond.hide();
      }
      <span class="hljs-keyword">if</span> (canvases.length &gt; <span class="hljs-number">2</span> &amp;&amp; canvases[<span class="hljs-number">2</span>].images.length) {
        <span class="hljs-keyword">const</span> imgSrcThird = $(<span class="hljs-string">`.thumb[data-uri='<span class="hljs-subst">${canvases[2].images[0].on}</span>']`</span>).attr(<span class="hljs-string">'data-src'</span>);
        $cmImgThird.attr(<span class="hljs-string">'src'</span>, imgSrcThird)
        .removeClass(<span class="hljs-string">'classified-manifest__third--placeholder'</span>);
      } <span class="hljs-keyword">else</span> {
        $cmImgThird.hide();
      }
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clean up - possible that derived manifests were listed but don&#39;t actually exist
Edge case</p></div></div><div class="code"><div class="wrapper">    $(<span class="hljs-string">'.classified-manifest:not(.classified-manifest--loaded)'</span>).remove();
  }
};</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>const cancelEdits = (resetText = false) =&gt; {
  const $contentEditableTitleText = $(&#39;.classified-manifest<strong>title-text[contenteditable]&#39;);
  const $contentEditableTitle = $(&#39;.classified-manifest</strong>title--edit&#39;);
  $contentEditableTitleText.removeAttr(&#39;contenteditable&#39;);
  $contentEditableTitle.removeClass(&#39;classified-manifest__title--edit&#39;);
  if (resetText) $contentEditableTitleText.html(lastTitleText);</p></div></div><div class="code"><div class="wrapper"><span class="hljs-comment">// ;</span>

<span class="hljs-keyword">const</span> Events = {
  bodyClick(e) {
    <span class="hljs-keyword">if</span> (
      e.target.className !== <span class="hljs-string">'classified-manifest__title-edit'</span> &amp;&amp;
      e.target.className !== <span class="hljs-string">'classified-manifest__title-save'</span> &amp;&amp;
      e.target.className !== <span class="hljs-string">'material-icons'</span>
    ) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>cancelEdits(true);</p></div></div><div class="code"><div class="wrapper">      $(<span class="hljs-string">'body'</span>).off(<span class="hljs-string">'click'</span>, Events.bodyClick);
    }
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>delete(e) {
  e.preventDefault();
  // Use a modal here - Are you sure you want to delete?
  $.magnificPopup.open(Config.deleteManifestModalOptions);</p>
<p>  // Grab manifest URL
  const $container = $(this).closest(&#39;.classified-manifest&#39;);
  const manifestId = $container.attr(&#39;data-id&#39;);</p>
<p>  // Hook up delete button behaviour (remove any existing click events)
  const $deleteButton = $(&#39;.manifest-modal__delete&#39;).off(&#39;click&#39;);
  $deleteButton.click(() =&gt; {
    // Show delete indicator
    $(&#39;html&#39;).addClass(&#39;deleting-manifest&#39;);</p>
<pre><code>$container.addClass(&#39;classified-manifest--deleting&#39;);

// Delete the manifest
IIIFActions.deleteManifest(manifestId, Events.deleteSuccess, Events.deleteError);</code></pre>
<p>  });</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>deleteError(/<em> xhr, textStatus,  error</em>/) {
  // console.log(&#39;ERROR DELETING&#39;, error);
  $(&#39;.classified-manifest--deleting&#39;).removeClass(&#39;classified-manifest--deleting&#39;);</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>deleteSuccess() {
  // Hide delete indicator
  $(&#39;html&#39;).removeClass(&#39;deleting-manifest&#39;);</p>
<p>  // Kill the item stack
  $(&#39;.classified-manifest--deleting&#39;).remove();</p>
<p>  // Close the modal
  $.magnificPopup.close();</p>
<p>  // Fetch updated derived manifest data
  Events.getCreatedManifests();</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span>
  domReady() {
    DOM.init();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set terms
DOM.$deleteModalHeading.html(<code>Are you sure you want to delete
  this ${getTerm(&#39;derivedManifest&#39;, 0)}?</code>);
DOM.$deleteModalStatus.html(<code>Deleting ${getTerm(&#39;derivedManifest&#39;, 0)}</code>);</p></div></div><div class="code"><div class="wrapper">    Events.init();
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>editTitleClick() {
  // Cancel any other edit operations first
  cancelEdits(true);</p>
<p>  // Make the title editable
  const $parentTitle = $(this).closest(&#39;.classified-manifest<strong>title&#39;);
  $parentTitle.addClass(&#39;classified-manifest</strong>title--edit&#39;);</p>
<p>  const $editableText = $parentTitle.find(&#39;.classified-manifest__title-text&#39;);</p>
<p>  lastTitleText = $editableText.text();
  $editableText.attr(&#39;contenteditable&#39;, &#39;true&#39;);
  $editableText.focus();
  $(&#39;body&#39;).click(Events.bodyClick);</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>editTitleKeypress(e) {
  if (e.key === &#39;Enter&#39;) {
    e.preventDefault();
    $(this).closest(&#39;.classified-manifest&#39;).find(&#39;.classified-manifest__title-save&#39;)
    .click();
  }</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span>
  getCreatedManifests() {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>get the container in presley</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> collectionId = SortyConfiguration
      .getCollectionUri(manifestStore.getState().manifest);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'delivered-manifests.Events.getCreatedManifests'</span>, collectionId);
    $.getJSON(collectionId)
        .done(Events.requestDerivedManifestsSuccess)
        .fail(Events.requestDerivedManifestsFailure);
  },
  init() {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>DOM.$classifiedMaterial.on(&#39;click&#39;,
&#39;.classified-manifest<strong>title-edit, .classified-manifest</strong>title-text&#39;,
Events.editTitleClick);
DOM.$classifiedMaterial.on(&#39;click&#39;, &#39;.classified-manifest<strong>title-save&#39;, Events.saveTitleClick);
DOM.$classifiedMaterial.on(&#39;keypress&#39;,
&#39;.classified-manifest</strong>title--edit .classified-manifest__title-text&#39;,
Events.editTitleKeypress
);</p></div></div><div class="code"><div class="wrapper">    DOM.$classifiedMaterial.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'.classified-manifest'</span>, (e) =&gt; e.stopPropagation());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>DOM.$classifiedMaterial.on(&#39;click&#39;, &#39;.action<strong>publish&#39;, Events.publish);
DOM.$classifiedMaterial.on(&#39;click&#39;, &#39;.action</strong>delete&#39;, Events.delete);
DOM.$classifiedMaterial.magnificPopup(Config.deleteManifestModalOptions);</p></div></div><div class="code"><div class="wrapper">  },
  postError(xhr, textStatus, error) {
    <span class="hljs-built_in">console</span>.log(error);
  },
  postSuccess() {
    cancelEdits();
    $(<span class="hljs-string">'.classified-manifest--saving-label'</span>).removeClass(<span class="hljs-string">'classified-manifest--saving-label'</span>);
  },
  postOmekaServiceError(xhr, textStatus, error) {
    <span class="hljs-built_in">console</span>.log(error);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>publish(e) {
  e.preventDefault();</p>
<p>  const oldHtml = $(this).html();
  $(this).html(&#39;loading...&#39;);
  getOmekaToken().then(({ accessToken }) =&gt; {
    const $container = $(this).closest(&#39;.classified-manifest&#39;);
    const manifestId = $container.attr(&#39;data-id&#39;);
    OmekaActions.pushToOmeka(manifestId, accessToken)
      .then(() =&gt; {
          // fulfilled
          OmekaActions.addOmekaService(manifestId).then(() =&gt; {
            Events.getCreatedManifests();
            $(this).html(oldHtml);
          });
        },
        () =&gt; {
          // rejected
          console.log(&#39;failed to push to omeka&#39;);
          // At the end.
          $(this).html(&#39;Failed to push to Omeka&#39;);
        });
  });</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span>
  putError(xhr, textStatus, error) {
    <span class="hljs-built_in">console</span>.log(error);
  },
  putSuccess() {
    <span class="hljs-keyword">const</span> manifest = store.getState().selectedCollection.collectionManifest;
    <span class="hljs-keyword">const</span> newManifestInstance = <span class="hljs-built_in">Object</span>.assign({}, manifest);
    newManifestInstance.sequences = <span class="hljs-literal">null</span>;
    newManifestInstance.service = <span class="hljs-literal">null</span>;
    IIIFActions.postCollection(
      manifest,
      SortyConfiguration.getCollectionUri(manifestStore.getState().manifest),
      SortyConfiguration.getCollectionAddUrl(),
      Events.postSuccess,
      Events.postError
    );
  },
  requestDerivedManifestsFailure() {
    manifestStore.dispatch(resetDerivedManifests());</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there&#39;s no derived manifest - just show the list</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'requestDerivedManifestsFailure'</span>);
    $(<span class="hljs-string">'html'</span>).addClass(<span class="hljs-string">'manifest-loaded'</span>);
  },
  requestDerivedManifestsSuccess(collection) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>IIIF.wrap(collection);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'requestDerivedManifestsSuccess'</span>, collection);
    manifestStore.dispatch(setDerivedManifests(collection));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;RDMS&#39;, collection);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> promises = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dm <span class="hljs-keyword">of</span> collection.members) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;dm&#39;, dm);</p></div></div><div class="code"><div class="wrapper">      promises.push(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
        $.getJSON(dm[<span class="hljs-string">'@id'</span>])
        .done(resolve)
        .fail((jqxhr, textStatus, error) =&gt; {
          <span class="hljs-built_in">console</span>.log(jqxhr, textStatus, error);
          <span class="hljs-keyword">if</span> (jqxhr.status === <span class="hljs-number">404</span>) {
            resolve();
          } <span class="hljs-keyword">else</span> {
            reject();
          }
        });
      }));
    }
    <span class="hljs-keyword">const</span> classifiedCanvases = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>();
    <span class="hljs-keyword">const</span> classifiedManifests = [];
    <span class="hljs-built_in">Promise</span>.all(promises).then(values =&gt; {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> manifest <span class="hljs-keyword">of</span> values) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> manifest !== <span class="hljs-string">'undefined'</span> &amp;&amp; manifest !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> canvas <span class="hljs-keyword">of</span> manifest.sequences[<span class="hljs-number">0</span>].canvases) {
            <span class="hljs-keyword">if</span> (canvas.images.length) {
              classifiedCanvases.add(canvas.images[<span class="hljs-number">0</span>].on);
            }
          }
          classifiedManifests.push(manifest);
        }
      }
      manifestStore.dispatch(setClassifiedCanvases(classifiedCanvases));
      manifestStore.dispatch(setDerivedManifestsComplete(classifiedManifests));

      $(<span class="hljs-string">'html'</span>).addClass(<span class="hljs-string">'dm-loaded manifest-loaded'</span>);
      updateThumbsWithStatus();
    }, reason =&gt; {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Promise fail'</span>, reason);
    });
    $(viewManifest).click(Events.viewManifestClick);
  },</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>saveTitleClick() {
  const $parentTitle = $(this).closest(&#39;.classified-manifest<strong>title&#39;);
  const $container = $(this).closest(&#39;.classified-manifest&#39;);
  const $editableText = $parentTitle.find(&#39;.classified-manifest</strong>title-text&#39;);
  const manifestId = $container.attr(&#39;data-id&#39;);
  const titleText = $editableText.text();
  const derivedManifests = manifestStore.getState().derivedManifestsComplete;
  let manifestToUpdate = null;
  for (const dm of derivedManifests) {
    if (dm[&#39;@id&#39;] === manifestId) {
      manifestToUpdate = dm;
      break;
    }
  }
  if (manifestToUpdate !== null) {
    // Update label
    manifestToUpdate.label = titleText;
    // Set saving state
    $container.addClass(&#39;classified-manifest--saving-label&#39;);
    // Store new manifest
    store.dispatch(setCollectionManifest(manifestToUpdate));
    // RE-PUT
    IIIFActions.addUpdateManifest(manifestToUpdate, Events.putSuccess, Events.putError);
  } else {
    // Cancel edit
    cancelEdits(true);
  }
  $(&#39;body&#39;).off(&#39;click&#39;, Events.bodyClick);</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-comment">// ,</span>
  subscribeActions() {
    <span class="hljs-keyword">const</span> derivedState = manifestStore.getState();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;DM - subscribe&#39;, lastLocalState, derivedState);</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (hasPropertyChanged(<span class="hljs-string">'derivedManifests'</span>, derivedState, lastLocalState)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;DM - changed&#39;, derivedState);</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> (derivedState.derivedManifests.length) {
        <span class="hljs-keyword">const</span> derivedManifestList = derivedState.derivedManifests;
        buildClassified(derivedManifestList);
      }
    }
    <span class="hljs-keyword">if</span> (hasPropertyChanged(<span class="hljs-string">'classifiedCanvases'</span>, derivedState, lastLocalState)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;classifiedCanvases changed&#39;, derivedState, lastLocalState);</p></div></div><div class="code"><div class="wrapper">    }
    <span class="hljs-keyword">if</span> (hasPropertyChanged(<span class="hljs-string">'derivedManifestsComplete'</span>, derivedState, lastLocalState)) {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>console.log(&#39;derivedManifestsComplete - updateArchivalUnits&#39;);</p></div></div><div class="code"><div class="wrapper">      updateArchivalUnits();
    }
    lastLocalState = derivedState;
  },
  viewManifestClick() {
    loadManifestPage(DOM.$manifestSelector.val());
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getCreatedManifests = Events.getCreatedManifests;

$(<span class="hljs-built_in">document</span>).ready(Events.domReady);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> derivedManifestsInit = (globalStore, globalManifestStore) =&gt; {
  store = globalStore;
  manifestStore = globalManifestStore;
  manifestStore.subscribe(Events.subscribeActions);
};</div></div></div></div></body></html>
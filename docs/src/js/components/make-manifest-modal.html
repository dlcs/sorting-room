<!DOCTYPE html><html lang="en"><head><title>src/js/components/make-manifest-modal</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="src/js/components/make-manifest-modal"><meta name="groc-project-path" content="src/js/components/make-manifest-modal.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/js/components/make-manifest-modal.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Sorty config</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> {
  SortyConfiguration,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../config/config.js'</span>;
<span class="hljs-keyword">import</span> {
  getTerm,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../config/terms.js'</span>;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>IIIF helpers</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> {
  IIIF,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../helpers/iiif.js'</span>;

<span class="hljs-keyword">import</span> {
 IIIFActions,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./iiif-actions.js'</span>;

<span class="hljs-keyword">import</span> {
  clearSelection,
  setCollectionName,
  setCollectionManifest,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../actions/selected-collection.js'</span>;

<span class="hljs-keyword">import</span> {
  getCreatedManifests,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/derived-manifests.js'</span>;

<span class="hljs-keyword">import</span> {
  switchView,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/workspace.js'</span>;

<span class="hljs-keyword">import</span> {
  resetDerivedManifests,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../actions/loaded-manifest.js'</span>;

<span class="hljs-keyword">const</span> $ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jquery'</span>);

<span class="hljs-keyword">let</span> store = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> manifestStore = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">const</span> DOM = {
  init() {
    DOM.$html = $(<span class="hljs-string">'html'</span>);
    DOM.$makeManifestButton = $(<span class="hljs-string">'.classify-tools__make'</span>);
    DOM.$manifestModalHeading = $(<span class="hljs-string">'.manifest-modal--make .manifest-modal__heading'</span>);
    DOM.$manifestModalInput = $(<span class="hljs-string">'.manifest-modal__input'</span>);
    DOM.$manifestModalSavingText = $(<span class="hljs-string">'.manifest-modal__saving-text'</span>);
    DOM.$modalCancel = $(<span class="hljs-string">'.manifest-modal__dismiss'</span>);
    DOM.$modalMakeManifest = $(<span class="hljs-string">'.manifest-modal__make'</span>);
    DOM.$savedCollection = $(<span class="hljs-string">'.saved__collection'</span>);
    DOM.$savedFeedback = $(<span class="hljs-string">'.saved__feedback'</span>);
    DOM.$savedProgress = $(<span class="hljs-string">'.saved__progress-bar'</span>);
    DOM.$viewer = $(<span class="hljs-string">'.viewer'</span>);
  },
};

<span class="hljs-keyword">const</span> Config = {
  manifestTemplate: {
    <span class="hljs-string">'@context'</span>: <span class="hljs-string">'http://iiif.io/api/presentation/2/context.json'</span>,
    <span class="hljs-string">'@id'</span>: <span class="hljs-string">'to be replaced'</span>,
    <span class="hljs-string">'@type'</span>: <span class="hljs-string">'sc:Manifest'</span>,
    label: <span class="hljs-string">'to be replaced'</span>,
    sequences: [
      {
        <span class="hljs-string">'@id'</span>: <span class="hljs-string">'to be replaced'</span>,
        <span class="hljs-string">'@type'</span>: <span class="hljs-string">'sc:Sequence'</span>,
        label: <span class="hljs-string">'Default sequence'</span>,
        canvases: [],
      },
    ],
  },
  canvasMapTemplate: {
    <span class="hljs-string">'@id'</span>: <span class="hljs-string">'to be replaced'</span>,
    <span class="hljs-string">'@context'</span>: <span class="hljs-string">'https://dlcs.info/context/presley'</span>,
    profile: <span class="hljs-string">'https://dlcs.info/profiles/canvasmap'</span>,
    canvasMap: {},
  },
  makeManifestModalOptions: {
    callbacks: {
      beforeOpen() {
        DOM.$html.addClass(<span class="hljs-string">'mfp-modal'</span>);
        <span class="hljs-keyword">const</span> state = store.getState();
        <span class="hljs-keyword">const</span> manifestState = manifestStore.getState();
        <span class="hljs-keyword">const</span> manifest = manifestState.manifest;
        <span class="hljs-keyword">const</span> selectedImages = state.selectedCollection.selectedImages;
        <span class="hljs-keyword">const</span> s = <span class="hljs-built_in">Math</span>.min.apply(<span class="hljs-built_in">Math</span>, selectedImages);
        <span class="hljs-keyword">const</span> e = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-built_in">Math</span>, selectedImages);
        <span class="hljs-keyword">const</span> label = store.getState().selectedCollection.collectionName !== <span class="hljs-literal">null</span>
        &amp;&amp; store.getState().selectedCollection.collectionName !== <span class="hljs-string">''</span> ?
        store.getState().selectedCollection.collectionName :
        SortyConfiguration.getManifestLabel(manifest, s, e).trim();
        DOM.$manifestModalInput.val(label);
      },
      beforeClose() {
        DOM.$html.removeClass(<span class="hljs-string">'mfp-modal'</span>);
      },
    },
    items: {
      src: <span class="hljs-string">'#manifestmodal'</span>,
      type: <span class="hljs-string">'inline'</span>,
    },
    modal: <span class="hljs-literal">true</span>,
  },
};

<span class="hljs-keyword">const</span> setSavingState = (saving) =&gt; {
  <span class="hljs-keyword">if</span> (saving) {
    $(<span class="hljs-string">'html'</span>).addClass(<span class="hljs-string">'saving-manifest'</span>);
    $(<span class="hljs-string">'.manifest-modal__input'</span>).attr(<span class="hljs-string">'readonly'</span>);
  } <span class="hljs-keyword">else</span> {
    $(<span class="hljs-string">'html'</span>).removeClass(<span class="hljs-string">'saving-manifest'</span>);
  }
};

<span class="hljs-keyword">const</span> Events = {
  domReady() {
    DOM.init();
    DOM.$modalCancel.click(Events.modalCancel);
    DOM.$modalMakeManifest.click(Events.modalMakeManifest);
    DOM.$makeManifestButton.magnificPopup(Config.makeManifestModalOptions);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set terms</p></div></div><div class="code"><div class="wrapper">    DOM.$manifestModalHeading.html(<span class="hljs-string">`Give your <span class="hljs-subst">${getTerm('derivedManifest', 0)}</span> a label?`</span>);
    DOM.$manifestModalSavingText.html(<span class="hljs-string">`Saving your <span class="hljs-subst">${getTerm('derivedManifest', 0)}</span>`</span>);
  },
  modalCancel() {
    $.magnificPopup.close();
  },
  modalMakeManifest() {
    <span class="hljs-keyword">const</span> state = store.getState();
    <span class="hljs-keyword">const</span> manifestState = manifestStore.getState();
    <span class="hljs-keyword">const</span> selectedImages = state.selectedCollection.selectedImages;
    <span class="hljs-keyword">const</span> manifest = manifestState.manifest;
    <span class="hljs-keyword">const</span> canvases = manifestState.canvases;
    <span class="hljs-keyword">const</span> s = <span class="hljs-built_in">Math</span>.min.apply(<span class="hljs-built_in">Math</span>, selectedImages);
    <span class="hljs-keyword">const</span> e = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-built_in">Math</span>, selectedImages);

    setSavingState(<span class="hljs-literal">true</span>);

    <span class="hljs-keyword">const</span> label = DOM.$manifestModalInput.val();
    <span class="hljs-keyword">const</span> canvasIds = selectedImages.map(idx =&gt; canvases[idx]).map(canvas =&gt; canvas[<span class="hljs-string">'@id'</span>]);
    <span class="hljs-keyword">const</span> collectionUrl = SortyConfiguration.getCollectionUri(manifest);

    IIIFActions.addManifestToCollection(collectionUrl, label, canvasIds).then((resp) =&gt; {
      store.dispatch(setCollectionManifest(resp));
      Events.postSuccess();
    }).catch((err) =&gt; {

      <span class="hljs-built_in">console</span>.log(err);
    });
  },
  postManifest(newManifest) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'is this called?'</span>);
    IIIFActions.postCollection(newManifest,
      SortyConfiguration.getCollectionUri(manifestStore.getState().manifest),
      SortyConfiguration.getCollectionAddUrl(),
      Events.postComplete,
      Events.postError);
  },
  postError(xhr, textStatus, error) {
    alert(error);
  },
  postSuccess() {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove loader</p></div></div><div class="code"><div class="wrapper">    setSavingState(<span class="hljs-literal">false</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Grab active thumbs</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> $activeThumbs = $(<span class="hljs-string">'.thumb--active'</span>);
    <span class="hljs-keyword">const</span> collectionName = store.getState().selectedCollection.collectionName;</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update preview title</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> savedFeedbackHtml = <span class="hljs-string">`
      &lt;i class="material-icons"&gt;done&lt;/i&gt; Your new set "<span class="hljs-subst">${collectionName}</span>" is saved.
      &lt;span&gt;&lt;a class="saved__make-set" href="#"&gt;Start another set&lt;/a&gt;, or
      &lt;a class="saved__view-sets" href="#"&gt;view all the sets&lt;/a&gt; ?&lt;/span&gt;`</span>;
    DOM.$savedFeedback.html(savedFeedbackHtml);
    DOM.$savedFeedback.find(<span class="hljs-string">'.saved__make-set'</span>).click(Events.savedMakeSetClick);
    DOM.$savedFeedback.find(<span class="hljs-string">'.saved__view-sets'</span>).click(Events.savedViewSetsClick);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clone thumbs for preview</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> $activeThumbsClone = $activeThumbs.parent().clone();
    $activeThumbsClone.find(<span class="hljs-string">'.thumb--active'</span>).removeClass(<span class="hljs-string">'thumb--active'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Display them as a preview</p></div></div><div class="code"><div class="wrapper">    DOM.$savedCollection.empty().append($activeThumbsClone);
    switchView(<span class="hljs-string">'saved'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Close the modal</p></div></div><div class="code"><div class="wrapper">    $.magnificPopup.close();</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update the progress bar&#39;s initial value</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">const</span> manifestState = manifestStore.getState();
    <span class="hljs-keyword">const</span> classifiedTotal = manifestState.classifiedCanvases.size;
    <span class="hljs-keyword">const</span> total = manifestState.allImages.length;
    <span class="hljs-keyword">const</span> progressVal = total &gt; <span class="hljs-number">0</span> ? <span class="hljs-built_in">Math</span>.round((classifiedTotal / total) * <span class="hljs-number">100</span>) : <span class="hljs-number">0</span>;
    DOM.$savedProgress.val(progressVal);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Give them the --classified class</p></div></div><div class="code"><div class="wrapper">    $activeThumbs.parent().addClass(<span class="hljs-string">'tc--classified'</span>);
    $activeThumbs.removeClass(<span class="hljs-string">'thumb--active'</span>);</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clear selection</p></div></div><div class="code"><div class="wrapper">    store.dispatch(clearSelection());
    store.dispatch(setCollectionName(<span class="hljs-string">''</span>));</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Push into derived manifests / derived manifests complete</p></div></div><div class="code"><div class="wrapper">    manifestStore.dispatch(resetDerivedManifests());
    getCreatedManifests();
  },
  putError(xhr, textStatus, error) {
    alert(error);
  },
  putSuccess() {
    <span class="hljs-keyword">const</span> manifest = store.getState().selectedCollection.collectionManifest;
    <span class="hljs-keyword">const</span> newManifestInstance = <span class="hljs-built_in">Object</span>.assign({}, manifest);
    newManifestInstance.sequences = <span class="hljs-literal">null</span>;
    newManifestInstance.service = <span class="hljs-literal">null</span>;
    IIIFActions.postCollection(
      manifest,
      SortyConfiguration.getCollectionUri(manifestStore.getState().manifest),
      SortyConfiguration.getCollectionAddUrl(),
      Events.postSuccess,
      Events.postError
    );
  },
  savedMakeSetClick(e) {
    e.preventDefault();
    switchView(<span class="hljs-string">'add'</span>);
  },
  savedViewSetsClick(e) {
    e.preventDefault();
    switchView(<span class="hljs-string">'done'</span>);
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> makeManifestInit = (globalStore, globalManifestStore) =&gt; {
  store = globalStore;
  manifestStore = globalManifestStore;
};

$(<span class="hljs-built_in">document</span>).ready(Events.domReady);</div></div></div></div></body></html>
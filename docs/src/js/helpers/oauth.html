<!DOCTYPE html><html lang="en"><head><title>src/js/helpers/oauth</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="src/js/helpers/oauth"><meta name="groc-project-path" content="src/js/helpers/oauth.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/js/helpers/oauth.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> {SortyConfiguration} <span class="hljs-keyword">from</span> <span class="hljs-string">"../config/config"</span>;

<span class="hljs-keyword">const</span> omekaAuthEndpoint = SortyConfiguration.oauthSiteEndpoint;
<span class="hljs-keyword">const</span> clientId = SortyConfiguration.oauthClientId;
<span class="hljs-keyword">const</span> redirect = SortyConfiguration.oauthCallback;
<span class="hljs-keyword">const</span> omekaTokenStore = {current: <span class="hljs-literal">null</span>, expires: <span class="hljs-literal">null</span>, hasExpired: <span class="hljs-literal">true</span>};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOmekaToken</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (!omekaTokenStore.hasExpired) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve({accessToken: omekaTokenStore.current, expires: omekaTokenStore.expires});
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
    <span class="hljs-keyword">const</span> state = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime();
    <span class="hljs-keyword">const</span> authLogin = <span class="hljs-string">`<span class="hljs-subst">${omekaAuthEndpoint}</span>/auth?response_type=code&amp;client_id=<span class="hljs-subst">${clientId}</span>&amp;redirect_uri=<span class="hljs-subst">${redirect}</span>&amp;scope=import-iiif&amp;state=<span class="hljs-subst">${state}</span>`</span>;
    <span class="hljs-built_in">window</span>.open(authLogin, <span class="hljs-string">'callback'</span>);
    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
      <span class="hljs-keyword">if</span> (e.data &amp;&amp; e.data.state.toString() === state.toString() &amp;&amp; e.data.code) {
        $.ajax(<span class="hljs-string">`<span class="hljs-subst">${omekaAuthEndpoint}</span>/auth/token`</span>, {
          type: <span class="hljs-string">'POST'</span>,
          crossDomain: <span class="hljs-literal">true</span>,
          contentType: <span class="hljs-string">'application/json; charset=utf-8'</span>,
          dataType: <span class="hljs-string">'json'</span>,
          data: <span class="hljs-built_in">JSON</span>.stringify({
            grant_type: <span class="hljs-string">'authorization_code'</span>,
            code: e.data.code,
            client_id: clientId,
          }),
          success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">{access_token, expires_in}</span>) </span>{
            omekaTokenStore.current = access_token;
            omekaTokenStore.hasExpired = <span class="hljs-literal">false</span>;
            omekaTokenStore.expires = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(r =&gt; setTimeout(() =&gt; {
              omekaTokenStore.hasExpired = <span class="hljs-literal">true</span>;
              r();
            }, expires_in * <span class="hljs-number">1000</span>));
            resolve({accessToken: omekaTokenStore.current, expires: omekaTokenStore.expires});
          },
          error: reject
        });
      } <span class="hljs-keyword">else</span> {
        reject();
      }
    });
  });
}

<span class="hljs-keyword">export</span> {
  getOmekaToken,

};</div></div></div></div></body></html>